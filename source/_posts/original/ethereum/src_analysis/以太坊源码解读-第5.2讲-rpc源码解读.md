---
title: 以太坊源码解读-第5.2讲-rpc源码解读
mathjax: false
copyright: true
original: true
date: 2018-05-03 14:04:01
categories: [原创,以太坊,源码解读]
tags: [ethereum]
---
## 前言
本文我们将分析rpc模块的源码，如果对rpc概念还不是很清楚的同学，建议先看看这篇文章[`以太坊源码解读-第5.1讲-rpc官翻及个人理解`](/articles/original/ethereum/src_analysis/以太坊源码解读-第5.1讲-rpc官翻及个人理解.html)
<!--more-->
先来看看该模块下有哪些文件：
.
|\_\_\_\_ipc_unix.go
|\_\_\_\_ipc_windows.go
|\_\_\_\_ipc.go
|\_\_\_\_http.go
|\_\_\_\_doc.go
|\_\_\_\_inproc.go
|\_\_\_\_utils.go
|\_\_\_\_websocket.go
|\_\_\_\_errors.go
|\_\_\_\_server.go
|\_\_\_\_server_test.go
|\_\_\_\_client.go
|\_\_\_\_client_example_test.go
|\_\_\_\_client_test.go
|\_\_\_\_subscription.go
|\_\_\_\_subscription_test.go
|\_\_\_\_utils_test.go
|\_\_\_\_http_test.go
|\_\_\_\_types.go
|\_\_\_\_types_test.go
|\_\_\_\_json.go
|\_\_\_\_json_test.go

文件很多，一眼看去真的很头大，小编借鉴[rpc源码分析-github](https://github.com/ZtesoftCS/go-ethereum-code-analysis/blob/master/rpc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md)中提供的一张图片先全局的介绍一下rpc模块中整体的文件结构，这样方便后面的理解：
{% asset_img 1.png  rpc模块文件结构 %}
图中`网络协议channels`和`Json`两部分，请其求和回应的编码和解码都是同时与服务端和客户端打交道的类。`网络协议channels`主要提供连接和数据传输的功能。 `json`的编码和解码主要提供请求和回应的序列化和反序列化功能(Json -> Go的对象)。
另外需要知道，各种对外的服务都是被注册到server中的。

## server_test.go和server.go源码
小编结合着server_test.go文件来讲解一下server.go源码。

### 先来看看server_test.go
为了方便测试，server_test.go中定义了一个`Service`，这个`Service`用来被注册到server中，它的结构和方法小编就不列出来了。
该测试文件中，提供了两个测试用例：
* 第一个是用来将服务注册到server中的。代码如下：
	```go
	func TestServerRegisterName(t *testing.T) {
		server := NewServer()  //server新实例
		service := new(Service)  //具体某服务的实例
		if err := server.RegisterName("calc", service); err != nil //根据名称将某服务注册
			t.Fatalf("%v", err)
		if len(server.services) != 2 
			t.Fatalf("Expected 2 service entries, got %d", len(server.services))
		svc, ok := server.services["calc"]  //获取某服务
		if !ok 
			t.Fatalf("Expected service calc to be registered")
		if len(svc.callbacks) != 5 
			t.Errorf("Expected 5 callbacks for service 'calc', got %d", len(svc.callbacks))
		if len(svc.subscriptions) != 1 
			t.Errorf("Expected 1 subscription for service 'calc', got %d", len(svc.subscriptions))
	}
	```



